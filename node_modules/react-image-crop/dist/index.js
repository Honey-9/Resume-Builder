import t,{PureComponent as e,createRef as i}from"react";function r(t,e,i){return Math.min(Math.max(t,e),i)}function o(t){return t&&t.width&&t.height}function s(t,e,i){const r=h({width:0,height:0,...t},e,i),o=r.aspect||1;return r.width&&(r.height=r.width/o),r.height&&(r.width=r.height*o),r.y+r.height>i&&(r.height=i-r.y,r.width=r.height*o),r.x+r.width>e&&(r.width=e-r.x,r.height=r.width/o),"px"===t.unit?r:n(r,e,i)}function n(t,e,i){return"%"===t.unit?t:{unit:"%",aspect:t.aspect,x:t.x/e*100,y:t.y/i*100,width:t.width/e*100,height:t.height/i*100}}function h(t,e,i){return t.unit?"px"===t.unit?t:{unit:"px",aspect:t.aspect,x:t.x*e/100,y:t.y*i/100,width:t.width*e/100,height:t.height*i/100}:{...t,unit:"px"}}function a(t,e,i,r){const o=h(e,i,r),s=h(t,i,r),n={...o};if(!o.aspect)return o.x<0?(n.x=0,n.width+=o.x):o.x+o.width>i&&(n.width=i-o.x),o.y+o.height>r&&(n.height=r-o.y),n;let a=!1;o.x<0?(n.x=0,n.width+=o.x,n.height=n.width/o.aspect,a=!0):o.x+o.width>i&&(n.width=i-o.x,n.height=n.width/o.aspect,a=!0),a&&s.y>n.y&&(n.y=o.y+(o.height-n.height));let c=!1;return n.y+n.height>r&&(n.height=r-o.y,n.width=n.height*o.aspect,c=!0),c&&s.x>n.x&&(n.x=o.x+(o.width-n.width)),n}function c(t,e,i,r,o){let s,n;return"nw"===e||"se"===e?(s=o/r,n=i.top-i.left*s):(s=-o/r,n=i.top+(o-i.left*s)),s*t+n}function d(t){var e,i,r="";if("string"==typeof t||"number"==typeof t)r+=t;else if("object"==typeof t)if(Array.isArray(t))for(e=0;e<t.length;e++)t[e]&&(i=d(t[e]))&&(r&&(r+=" "),r+=i);else for(e in t)t[e]&&(r&&(r+=" "),r+=e);return r}const p={aspect:0,x:0,y:0,width:0,height:0,unit:"px"};class l extends e{constructor(){super(...arguments),this.componentRef=i(),this.cropSelectRef=i(),this.mouseDownOnCrop=!1,this.dragStarted=!1,this.keysDown=new Set,this.evData={clientStartX:0,clientStartY:0,cropStartWidth:0,cropStartHeight:0,cropStartX:0,cropStartY:0,xDiff:0,yDiff:0,xDiffPc:0,yDiffPc:0,xInversed:!1,yInversed:!1,xCrossOver:!1,yCrossOver:!1,startXCrossOver:!1,startYCrossOver:!1,isResize:!1,ord:"nw",cropOffset:{top:0,left:0}},this.state={dimensions:{width:0,height:0}},this.onCropPointerDown=t=>{var e,i;const{crop:r=p,disabled:o}=this.props,{width:s,height:n}=this.state.dimensions,a=h(r,s,n),c=this.componentRef.current;if(o||!c)return;t.preventDefault(),this.bindDocMove(),c.focus({preventScroll:!0});const d=null===(e=t.target)||void 0===e?void 0:e.dataset.ord,l="nw"===d||"w"===d||"sw"===d,f="nw"===d||"n"===d||"ne"===d,g=a.aspect?{top:c.offsetTop,left:c.offsetLeft}:{top:0,left:0};this.evData={clientStartX:t.pageX,clientStartY:t.pageY,cropStartWidth:a.width,cropStartHeight:a.height,cropStartX:l?a.x+a.width:a.x,cropStartY:f?a.y+a.height:a.y,xDiff:0,yDiff:0,xDiffPc:0,yDiffPc:0,xInversed:l,yInversed:f,xCrossOver:l,yCrossOver:f,startXCrossOver:l,startYCrossOver:f,isResize:Boolean(null===(i=t.target)||void 0===i?void 0:i.dataset.ord),ord:d,cropOffset:g},this.mouseDownOnCrop=!0,this.setState({cropIsActive:!0})},this.onComponentPointerDown=t=>{const e=this.componentRef.current,i=null==e?void 0:e.firstChild;if(!e||t.target!==i)return;const{crop:r,disabled:s,locked:a,keepSelection:c,onChange:d}=this.props;if(s||a||c&&o(r))return;t.preventDefault(),this.bindDocMove(),e.focus({preventScroll:!0});const p={unit:"px",aspect:r?r.aspect:void 0,x:t.nativeEvent.offsetX,y:t.nativeEvent.offsetY,width:0,height:0};this.evData={clientStartX:t.pageX,clientStartY:t.pageY,cropStartWidth:p.width,cropStartHeight:p.height,cropStartX:p.x,cropStartY:p.y,xDiff:0,yDiff:0,xDiffPc:0,yDiffPc:0,xInversed:!1,yInversed:!1,xCrossOver:!1,yCrossOver:!1,startXCrossOver:!1,startYCrossOver:!1,isResize:!0,ord:"nw",cropOffset:{top:0,left:0}},this.mouseDownOnCrop=!0;const{width:l,height:f}=this.state.dimensions;d&&d(h(p,l,f),n(p,l,f)),this.setState({cropIsActive:!0,newCropIsBeingDrawn:!0})},this.onDocPointerMove=t=>{const{crop:e,disabled:i,onChange:r,onDragStart:o}=this.props;if(i)return;if(!this.mouseDownOnCrop)return;t.preventDefault(),this.dragStarted||(this.dragStarted=!0,o&&o(t));const{evData:s}=this,a={x:t.pageX,y:t.pageY};let d;if(s.isResize&&(null==e?void 0:e.aspect)&&s.cropOffset&&(a.y=c(a.x,s.ord,s.cropOffset,s.cropStartWidth,s.cropStartHeight)),s.xDiff=a.x-s.clientStartX,s.yDiff=a.y-s.clientStartY,d=s.isResize?this.resizeCrop():this.dragCrop(),d!==e){const{width:t,height:e}=this.state.dimensions;r(h(d,t,e),n(d,t,e))}},this.onComponentKeyDown=t=>{const{crop:e,disabled:i,onChange:s,onComplete:a}=this.props;if(i)return;this.keysDown.add(t.key);let c=!1;if(!o(e))return;const d=this.makeNewCrop(),p=(navigator.platform.match("Mac")?t.metaKey:t.ctrlKey)?l.nudgeStepLarge:t.shiftKey?l.nudgeStepMedium:l.nudgeStep;if(this.keysDown.has("ArrowLeft")&&(d.x-=p,c=!0),this.keysDown.has("ArrowRight")&&(d.x+=p,c=!0),this.keysDown.has("ArrowUp")&&(d.y-=p,c=!0),this.keysDown.has("ArrowDown")&&(d.y+=p,c=!0),c){t.preventDefault();const{width:e,height:i}=this.state.dimensions;d.x=r(d.x,0,e-d.width),d.y=r(d.y,0,i-d.height);const o=h(d,e,i),c=n(d,e,i);s(o,c),a&&a(o,c)}},this.onComponentKeyUp=t=>{this.keysDown.delete(t.key)},this.onDocPointerDone=t=>{const{crop:e=p,disabled:i,onComplete:r,onDragEnd:o}=this.props;if(this.unbindDocMove(),!i&&this.mouseDownOnCrop){this.mouseDownOnCrop=!1,this.dragStarted=!1;const{width:i,height:s}=this.state.dimensions;o&&o(t),r&&r(h(e,i,s),n(e,i,s)),this.setState({cropIsActive:!1,newCropIsBeingDrawn:!1})}}}componentDidMount(){if(this.componentRef.current){const t=this.componentRef.current;this.setState({dimensions:{width:t.clientWidth,height:t.clientHeight}}),this.resizeObserver=new ResizeObserver((([t])=>{this.setState({dimensions:{width:t.contentRect.width,height:t.contentRect.height}}),console.log("Size changed",t.contentRect.width,t.contentRect.height)})),this.resizeObserver.observe(t)}}componentWillUnmount(){var t;null===(t=this.resizeObserver)||void 0===t||t.disconnect()}bindDocMove(){"undefined"!=typeof document&&(document.addEventListener("pointermove",this.onDocPointerMove),document.addEventListener("pointerup",this.onDocPointerDone),document.addEventListener("pointercancel",this.onDocPointerDone))}unbindDocMove(){"undefined"!=typeof document&&(document.removeEventListener("pointermove",this.onDocPointerMove),document.removeEventListener("pointerup",this.onDocPointerDone),document.removeEventListener("pointercancel",this.onDocPointerDone))}getCropStyle(){const t=this.makeNewCrop(this.props.crop?this.props.crop.unit:"px");return{top:`${t.y}${t.unit}`,left:`${t.x}${t.unit}`,width:`${t.width}${t.unit}`,height:`${t.height}${t.unit}`}}getNewSize(){const{crop:t,minWidth:e=0,maxWidth:i,minHeight:o=0,maxHeight:s}=this.props,{evData:n}=this,{width:h,height:a}=this.state.dimensions;if(!t)return{width:0,height:0};let c,d=n.cropStartWidth+n.xDiff;return n.xCrossOver&&(d=Math.abs(d)),d=r(d,e,i||h),c=t.aspect?d/t.aspect:n.cropStartHeight+n.yDiff,n.yCrossOver&&(c=Math.min(Math.abs(c),n.cropStartY)),c=r(c,o,s||a),t.aspect&&(d=r(c*t.aspect,0,h)),{width:d,height:c}}dragCrop(){const t=this.makeNewCrop(),{evData:e}=this,{width:i,height:o}=this.state.dimensions;return t.x=r(e.cropStartX+e.xDiff,0,i-t.width),t.y=r(e.cropStartY+e.yDiff,0,o-t.height),t}resizeCrop(){const{evData:t}=this,{crop:e=p}=this.props,i=this.makeNewCrop(),{ord:r}=t;t.xInversed&&(t.xDiff-=2*t.cropStartWidth,t.xDiffPc-=2*t.cropStartWidth),t.yInversed&&(t.yDiff-=2*t.cropStartHeight,t.yDiffPc-=2*t.cropStartHeight);const o=this.getNewSize();let s=t.cropStartX,n=t.cropStartY;t.xCrossOver&&(s=i.x+(i.width-o.width)),t.yCrossOver&&(n=!1===t.lastYCrossover?i.y-o.height:i.y+(i.height-o.height));const{width:h,height:c}=this.state.dimensions,d=a(e,{unit:i.unit,x:s,y:n,width:o.width,height:o.height,aspect:i.aspect},h,c);return i.aspect||l.xyOrds.indexOf(r)>-1?(i.x=d.x,i.y=d.y,i.width=d.width,i.height=d.height):l.xOrds.indexOf(r)>-1?(i.x=d.x,i.width=d.width):l.yOrds.indexOf(r)>-1&&(i.y=d.y,i.height=d.height),t.lastYCrossover=t.yCrossOver,this.crossOverCheck(this.evData),i}createCropSelection(){const{disabled:e,locked:i,ruleOfThirds:r,crop:o}=this.props,s=this.getCropStyle();return t.createElement("div",{ref:this.cropSelectRef,style:s,className:"ReactCrop__crop-selection",onPointerDown:this.onCropPointerDown},!e&&!i&&t.createElement("div",{className:"ReactCrop__drag-elements"},t.createElement("div",{className:"ReactCrop__drag-bar ord-n","data-ord":"n"}),t.createElement("div",{className:"ReactCrop__drag-bar ord-e","data-ord":"e"}),t.createElement("div",{className:"ReactCrop__drag-bar ord-s","data-ord":"s"}),t.createElement("div",{className:"ReactCrop__drag-bar ord-w","data-ord":"w"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-nw","data-ord":"nw"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-n","data-ord":"n"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-ne","data-ord":"ne"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-e","data-ord":"e"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-se","data-ord":"se"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-s","data-ord":"s"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-sw","data-ord":"sw"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-w","data-ord":"w"})),r&&t.createElement(t.Fragment,null,t.createElement("div",{className:"ReactCrop__rule-of-thirds-hz"}),t.createElement("div",{className:"ReactCrop__rule-of-thirds-vt"})))}makeNewCrop(t="px"){var e,i,r,o,s;const a=this.props.crop||p,c={unit:a.unit||t,aspect:null!==(e=a.aspect)&&void 0!==e?e:p.aspect,x:null!==(i=a.x)&&void 0!==i?i:p.x,y:null!==(r=a.y)&&void 0!==r?r:p.y,width:null!==(o=a.width)&&void 0!==o?o:p.width,height:null!==(s=a.height)&&void 0!==s?s:p.height},{width:d,height:l}=this.state.dimensions;return"px"===t?h(c,d,l):n(c,d,l)}crossOverCheck(t){const{minWidth:e,minHeight:i}=this.props;!e&&(!t.xCrossOver&&-Math.abs(t.cropStartWidth)-t.xDiff>=0||t.xCrossOver&&-Math.abs(t.cropStartWidth)-t.xDiff<=0)&&(t.xCrossOver=!t.xCrossOver),!i&&(!t.yCrossOver&&-Math.abs(t.cropStartHeight)-t.yDiff>=0||t.yCrossOver&&-Math.abs(t.cropStartHeight)-t.yDiff<=0)&&(t.yCrossOver=!t.yCrossOver)}render(){const{children:e,circularCrop:i,className:r,style:s,crop:n,disabled:h,locked:a,ruleOfThirds:c}=this.props,{width:p,height:l}=this.state.dimensions,{cropIsActive:f,newCropIsBeingDrawn:g}=this.state,w=p&&l&&o(n)?this.createCropSelection():null,v=function(...t){for(var e,i,r=0,o="";r<t.length;)(e=t[r++])&&(i=d(e))&&(o&&(o+=" "),o+=i);return o}("ReactCrop",r,{"ReactCrop--active":f,"ReactCrop--disabled":h,"ReactCrop--locked":a,"ReactCrop--new-crop":g,"ReactCrop--fixed-aspect":n&&n.aspect,"ReactCrop--circular-crop":n&&i,"ReactCrop--rule-of-thirds":n&&c,"ReactCrop--invisible-crop":!this.dragStarted&&n&&!n.width&&!n.height});return t.createElement("div",{ref:this.componentRef,className:v,style:s,tabIndex:0,onPointerDown:this.onComponentPointerDown,onKeyDown:this.onComponentKeyDown,onKeyUp:this.onComponentKeyUp},e,w)}}l.xOrds=["e","w"],l.yOrds=["n","s"],l.xyOrds=["nw","ne","se","sw"],l.nudgeStep=1,l.nudgeStepMedium=10,l.nudgeStepLarge=100;export{l as Crop,p as EMPTY_CROP,r as clamp,a as containCrop,n as convertToPercentCrop,h as convertToPixelCrop,o as isCropDrawn,s as makeAspectCrop,c as straightenYPath};
